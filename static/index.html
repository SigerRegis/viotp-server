<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RegisFone</title>

<style>
body {
    font-family: Arial, sans-serif;
    max-width: 420px;
    margin: auto;
    padding: 16px;
}
button {
    width: 100%;
    padding: 14px;
    margin-top: 12px;
    font-size: 16px;
}
.box {
    border: 1px solid #ccc;
    padding: 12px;
    margin-top: 15px;
    white-space: pre-line;
}
</style>
</head>

<body>

<script>
(function () {
    const PASSWORD = "3333";
    const saved = sessionStorage.getItem("auth_ok");

    if (!saved) {
        const input = prompt("ğŸ” Nháº­p máº­t kháº©u truy cáº­p:");
        if (input !== PASSWORD) {
            alert("âŒ Sai máº­t kháº©u");
            document.body.innerHTML = "<h3>âŒ Truy cáº­p bá»‹ tá»« chá»‘i</h3>";
            throw new Error("Unauthorized");
        }
        sessionStorage.setItem("auth_ok", "1");
    }
})();
</script>

<h2>ğŸ“± RegisFone</h2>

<div class="box" id="balance">â³ Äang táº£i sá»‘ dÆ°...</div>

<button onclick="rentSim()">ğŸš€ Mua</button>

<div class="box" id="result"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {

let requestId = null;
let cellphoneServiceId = null;
let phoneNumber = "";
let otpCode = "";

async function init() {
    const bal = await fetch("/api/balance").then(r => r.json());
    document.getElementById("balance").innerText =
        "ğŸ’° Sá»‘ dÆ°: " + bal.data.balance;

    const sv = await fetch("/api/services").then(r => r.json());
    sv.data.forEach(s => {
        if (s.name && s.name.toLowerCase().includes("cell")) {
            cellphoneServiceId = s.id;
        }
    });

    if (!cellphoneServiceId) {
        document.getElementById("result").innerText =
            "âŒ KhÃ´ng tÃ¬m tháº¥y dá»‹ch vá»¥";
    }
}

window.rentSim = async function () {
    document.getElementById("result").innerText = "â³ Äang mua...";

    const res = await fetch(`/api/rent?service_id=${cellphoneServiceId}`, {
        method: "POST"
    }).then(r => r.json());

    if (res.status_code !== 200) {
        document.getElementById("result").innerText = "âŒ " + res.message;
        return;
    }

    phoneNumber = "0" + res.data.phone_number;
    requestId = res.data.request_id;

    document.getElementById("result").innerHTML =
        "ğŸ“ Sá»‘: <b>" + phoneNumber + "</b><br>" +
        "<button onclick=\"copyText('" + phoneNumber + "')\">ğŸ“‹ Copy SÄT</button><br><br>" +
        "â³ Äang chá» OTP...";

    pollOTP();
};

async function pollOTP() {
    const res = await fetch(`/api/otp/${requestId}`).then(r => r.json());

    if (res.data && res.data.Status === 1) {
        otpCode = res.data.Code;
        document.getElementById("result").innerHTML +=
            "<br><br>ğŸ” OTP: <b>" + otpCode + "</b><br>" +
            "<button onclick=\"copyText('" + otpCode + "')\">ğŸ“‹ Copy OTP</button>";
    } else {
        setTimeout(pollOTP, 5000);
    }
}

window.copyText = function (text) {
    navigator.clipboard.writeText(text);
    alert("âœ… ÄÃ£ copy: " + text);
};

init();
});
</script>

</body>
</html>
