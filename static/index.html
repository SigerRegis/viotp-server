<script>
document.addEventListener("DOMContentLoaded", () => {

let requestId = localStorage.getItem("requestId");
let cellphoneServiceId = localStorage.getItem("serviceId");
let phoneNumber = localStorage.getItem("phoneNumber");
let otpCode = localStorage.getItem("otpCode");

async function init() {
    try {
        const bal = await fetch("/api/balance").then(r => r.json());
        document.getElementById("balance").innerText =
            "ğŸ’° Sá»‘ dÆ°: " + bal.data.balance;

        // Náº¿u chÆ°a cÃ³ serviceId thÃ¬ load service
        if (!cellphoneServiceId) {
            const sv = await fetch("/api/services").then(r => r.json());
            sv.data.forEach(s => {
                if (s.name && s.name.toLowerCase().includes("cell")) {
                    cellphoneServiceId = s.id;
                    localStorage.setItem("serviceId", cellphoneServiceId);
                }
            });
        }

        // Náº¿u Ä‘ang chá» OTP â†’ khÃ´i phá»¥c UI
        if (requestId && phoneNumber && !otpCode) {
            document.getElementById("result").innerHTML =
                `ğŸ“ Sá»‘: <b>${phoneNumber}</b><br>
                 <button onclick="copyText('${phoneNumber}')">ğŸ“‹ Copy SÄT</button><br><br>
                 â³ Äang chá» OTP...`;
            pollOTP();
        }

        // Náº¿u Ä‘Ã£ cÃ³ OTP
        if (otpCode) {
            document.getElementById("result").innerHTML =
                `ğŸ“ Sá»‘: <b>${phoneNumber}</b><br>
                 <button onclick="copyText('${phoneNumber}')">ğŸ“‹ Copy SÄT</button><br><br>
                 ğŸ” OTP: <b>${otpCode}</b><br>
                 <button onclick="copyText('${otpCode}')">ğŸ“‹ Copy OTP</button>`;
        }

    } catch (e) {
        document.getElementById("result").innerText = "âŒ Lá»—i init: " + e;
    }
}

window.rentSim = async function () {
    document.getElementById("result").innerText = "â³ Äang thuÃª SIM...";

    const res = await fetch(`/api/rent?service_id=${cellphoneServiceId}`, {
        method: "POST"
    }).then(r => r.json());

    if (res.status_code !== 200) {
        document.getElementById("result").innerText = "âŒ " + res.message;
        return;
    }

    phoneNumber = "0" + res.data.phone_number;
    requestId = res.data.request_id;

    localStorage.setItem("phoneNumber", phoneNumber);
    localStorage.setItem("requestId", requestId);
    localStorage.removeItem("otpCode");

    document.getElementById("result").innerHTML =
        `ğŸ“ Sá»‘: <b>${phoneNumber}</b><br>
         <button onclick="copyText('${phoneNumber}')">ğŸ“‹ Copy SÄT</button><br><br>
         â³ Äang chá» OTP...`;

    pollOTP();
};

async function pollOTP() {
    const res = await fetch(`/api/otp/${requestId}`).then(r => r.json());

    if (res.data && res.data.Status === 1) {
        otpCode = res.data.Code;
        localStorage.setItem("otpCode", otpCode);

        document.getElementById("result").innerHTML +=
            `<br><br>ğŸ” OTP: <b>${otpCode}</b><br>
             <button onclick="copyText('${otpCode}')">ğŸ“‹ Copy OTP</button>`;
    } else {
        setTimeout(pollOTP, 5000);
    }
}

window.copyText = function (text) {
    navigator.clipboard.writeText(text);
    alert("âœ… ÄÃ£ copy: " + text);
};

// (tuá»³ chá»n) nÃºt reset session
window.clearSession = function () {
    localStorage.clear();
    location.reload();
};

init();
});
</script>
